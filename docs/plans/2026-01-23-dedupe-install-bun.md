# Dedupe Install (Bun) Implementation Plan
> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Make “deduped skills install” explicit and ergonomic for both local-clone users and `curl | sh` / `install.sh` users, using `bun` (not npm/pnpm/yarn).

**Architecture:** Keep the current `skills/.deduped` generation model (symlink-based mirror tree generated by `bun scripts/dedupe-skills.ts`). Add a lowercase `install.sh` wrapper and add explicit installer flags to control dedupe behavior.

**Tech Stack:** POSIX `sh` (`INSTALL.sh`), `bun` runtime (for `scripts/dedupe-skills.ts`), `git`.

---

### Task 1: Keep a single installer entrypoint (`INSTALL.sh`)

**Files:**
- Modify: `INSTALL.sh`

**Note:**
- Don’t add a second `install.sh` alongside `INSTALL.sh` because many contributors are on case-insensitive filesystems (macOS/Windows), where the two names collide.
  - If you want a short alias in the future, prefer something like `./install` (no extension) to avoid case-collision.

---

### Task 2: Add explicit dedupe flags to `INSTALL.sh`

**Files:**
- Modify: `INSTALL.sh`

**Step 1: Define CLI flags**
- Add:
  - `--dedupe` (default behavior: auto; prefer existing `skills/.deduped`, else generate if `bun` available)
  - `--no-dedupe` (force raw `skills/` even if `.deduped` exists)
  - `--dedupe-only` (generate `skills/.deduped` then exit without linking)
  - Optional: `--dedupe-force` (regenerate even if `.deduped` exists)

**Step 2: Implement bun resolution**
- Support `BUN_BIN` env var as override (e.g. `BUN_BIN=$HOME/.bun/bin/bun`).
- Otherwise use `command -v bun`.

**Step 3: Smoke check**
- Run: `./INSTALL.sh --help`
- Run (dry): `BUN_BIN=bun ./INSTALL.sh --dedupe-only` (should succeed when `bun` exists)

---

### Task 3: Update README for the two user types

**Files:**
- Modify: `README.md`

**Step 1: Document local-clone flow**
- Show: `bun scripts/dedupe-skills.ts --root . --out skills/.deduped` then `./INSTALL.sh`.

**Step 2: Document “others via install.sh” flow**
- Show: `curl ... | sh` + note “install bun to enable dedupe” or “pass `--no-dedupe` to skip”.
- Mention lowercase `install.sh` exists for convenience.

---

### Task 4: Validate end-to-end behavior

**Steps:**
- Run: `rm -rf skills/.deduped && ./INSTALL.sh --dedupe-only` (should create `skills/.deduped` + `skills/.deduped/MANIFEST.json`)
- Run: `./INSTALL.sh --no-dedupe --project /tmp/test-proj` (should link raw `skills/` into `/tmp/test-proj/.codex/skills`)
- Run: `./INSTALL.sh --dedupe --project /tmp/test-proj` (should link `.deduped` when present)
